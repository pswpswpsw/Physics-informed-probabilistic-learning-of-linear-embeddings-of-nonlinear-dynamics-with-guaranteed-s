

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MODEL_SRC.classBayesDLKoopman &mdash; SPARK 1.2rc1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SPARK
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Simple example</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SPARK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>MODEL_SRC.classBayesDLKoopman</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for MODEL_SRC.classBayesDLKoopman</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;It contains three classs of Continuous time Deep Learning Models for Koopman Operator with Bayes</span>

<span class="sd">    Class List:</span>

<span class="sd">    1. :class:`edwardMBTrainer`</span>
<span class="sd">    2. :class:`edwardMBTrainerLRAN`</span>
<span class="sd">    3. :class:`ClassBayesDLKoopman`</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_C_API_GRAPH_CONSTRUCTION&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;0&#39;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">edward</span> <span class="k">as</span> <span class="nn">ed</span>
<span class="n">sys</span><span class="o">.</span><span class="n">dont_write_bytecode</span> <span class="o">=</span> <span class="kc">True</span>
<span class="kn">import</span> <span class="nn">GPUtil</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">ClassDLKoopmanCont</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ClassDLKoopmanLRAN</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">lib.utilities</span> <span class="k">import</span> <span class="n">TF_FLOAT</span>
<span class="kn">from</span> <span class="nn">edward.models</span> <span class="k">import</span> <span class="n">InverseGamma</span><span class="p">,</span> <span class="n">MultivariateNormalDiag</span><span class="p">,</span> <span class="n">Cauchy</span>
<span class="kn">from</span> <span class="nn">tensorflow.contrib.distributions</span> <span class="k">import</span> <span class="n">bijectors</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Set CUDA_DEVICE_ORDER so the IDs assigned by CUDA match those from nvidia-smi</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_DEVICE_ORDER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PCI_BUS_ID&quot;</span>
    <span class="c1"># Get the first available GPU</span>
    <span class="n">DEVICE_ID_LIST</span> <span class="o">=</span> <span class="n">GPUtil</span><span class="o">.</span><span class="n">getFirstAvailable</span><span class="p">(</span><span class="n">maxLoad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">maxMemory</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">DEVICE_ID</span> <span class="o">=</span> <span class="n">DEVICE_ID_LIST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># grab first element from list</span>
    <span class="c1"># Set CUDA_VISIBLE_DEVICES to mask out all other GPUs than the first available device id</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DEVICE_ID</span><span class="p">)</span>

<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CPU mode&#39;</span><span class="p">)</span>




<div class="viewcode-block" id="ClassBayesDLKoopman"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman">[docs]</a><span class="k">class</span> <span class="nc">ClassBayesDLKoopman</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class of Deep Leraning Koopman with Bayesian Deep Learning.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (:obj:`numpy.ndarray`): training data with key ``Xtrain`` and ``XdotTrain`` for :attr:`LRAN_mode` =</span>
<span class="sd">            ``False`` while only with ``Xtrain`` otherwise.</span>

<span class="sd">        configDict (:obj:`dict`): config dictionary for deterministic DL Koopman</span>

<span class="sd">        mc_sample (:obj:`int`): number of Monte carlo sampling in using the reparameterization trick.</span>
<span class="sd">            We recommend 1. The higher it is, the less variance there is in the gradient estimation.</span>

<span class="sd">        edward_configDict (:obj:`dict`): config dictionary for bayesian DL Koopman.</span>

<span class="sd">        cut_data_range (:obj:`numpy.ndarray`): Specifiy the range for training data. If ``None``, then we don&#39;t use it.</span>

<span class="sd">        LRAN_mode (:obj:`bool`): Using LRAN or not.</span>

<span class="sd">        gpu_percentage (:obj:`float`): gpu memory usage ratio. Default value is 0.5.</span>

<span class="sd">    Attributes:</span>

<span class="sd">        model (:obj:`class`): Deterministic DL Koopman model class from ``ClassDLKoopmanCont``.</span>

<span class="sd">        residual_vector_rec_loss (:obj:`tf.Tensor`): residual reconstruction loss vector as the output of deterministic</span>
<span class="sd">            network as likelihood.</span>

<span class="sd">        residual_vector_lin_loss (:obj:`tf.Tensor`): residual linear loss vector as the output of deterministic</span>
<span class="sd">            network as likelihood.</span>

<span class="sd">        z_ph (:obj:`tf.Tensor`): concanteted ``z_rec_loss`` and ``z_lin_loss`` as general loss target to minimize.</span>

<span class="sd">        vp_dict (:obj:`dict`): dictionary collection of variational posteriori</span>

<span class="sd">        sess (:obj:`class`): current session used in Tensorflow.</span>

<span class="sd">        graph (:obj:`class`): current graph being used.</span>

<span class="sd">        verbose (:obj:`bool`): logging flags.</span>

<span class="sd">        mode (:obj:`str`): choose which mode to take on ADVI.</span>

<span class="sd">        LRAN_mode (:obj:`bool`): choose using ``recurrent`` or ``differential`` form.</span>

<span class="sd">        dir (:obj:`str`): path to saving directory.</span>

<span class="sd">        mc_sample (:obj:`int`): number of MC samples to choose for approximating the reparameterization trick.</span>

<span class="sd">        init_mode (:obj:`str`): ``Standard`` or ``nonBayes`` as using default weights initialization or simply use previous run.</span>

<span class="sd">        MAP_dir (:obj:`str`): if :attr:`init_mode` is turned with ``nonBayes``, then one needs to give the path to previous trained model.</span>

<span class="sd">        init_std_softplus (:obj:`float`): initialization of the standard deviation for softplus for the scales. The smaller the more negative, the weights will be smaller.</span>

<span class="sd">        optimizer (:obj:`str`): the name for the optimizer in tensorflow used in the training process. For example, ``adam``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">configDict</span><span class="p">,</span> <span class="n">mc_sample</span><span class="p">,</span> <span class="n">edward_configDict</span><span class="p">,</span> <span class="n">cut_data_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">LRAN_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gpu_percentage</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>

        <span class="c1"># construct the graph in Cont model</span>

        <span class="k">if</span> <span class="n">LRAN_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1">## Differential form Bayesian</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">ClassDLKoopmanCont</span><span class="p">(</span><span class="n">configDict</span><span class="o">=</span><span class="n">configDict</span><span class="p">,</span> <span class="n">edward_configDict</span><span class="o">=</span><span class="n">edward_configDict</span><span class="p">)</span>

            <span class="c1"># obtaining data</span>

            <span class="k">if</span> <span class="n">cut_data_range</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getX_Xdot</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">],</span> <span class="n">Xdot</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;XdotTrain&#39;</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">x1_range</span> <span class="o">=</span> <span class="n">cut_data_range</span><span class="p">[</span><span class="s1">&#39;x1_range&#39;</span><span class="p">]</span>
                <span class="n">x2_range</span> <span class="o">=</span> <span class="n">cut_data_range</span><span class="p">[</span><span class="s1">&#39;x2_range&#39;</span><span class="p">]</span>

                <span class="n">index_after_cut</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x1_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x1_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
                            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x2_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x2_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="nb">print</span> <span class="s1">&#39;data size before cut = &#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">cut_Xtrain</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">][</span><span class="n">index_after_cut</span><span class="p">]</span>
                <span class="n">cut_XdotTrain</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;XdotTrain&#39;</span><span class="p">][</span><span class="n">index_after_cut</span><span class="p">]</span>
                <span class="nb">print</span> <span class="s1">&#39;data size after cut = &#39;</span><span class="p">,</span> <span class="n">cut_Xtrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getX_Xdot</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">cut_Xtrain</span><span class="p">,</span> <span class="n">Xdot</span><span class="o">=</span><span class="n">cut_XdotTrain</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1">## LRAN form Bayesian</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">ClassDLKoopmanLRAN</span><span class="p">(</span><span class="n">configDict</span><span class="o">=</span><span class="n">configDict</span><span class="p">,</span> <span class="n">edward_configDict</span><span class="o">=</span><span class="n">edward_configDict</span><span class="p">,</span> <span class="n">gpu_percentage</span><span class="o">=</span><span class="n">gpu_percentage</span><span class="p">)</span>

            <span class="c1"># only use Xtrain, not XdotTrain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_hankel_data</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xtrain&#39;</span><span class="p">])</span>


        <span class="c1"># construct model graph with total reconstruction residual vector</span>
        <span class="c1"># and linear dynamical residual vector and prior dictionary</span>
        <span class="c1"># and hyperparameter dictionary defined</span>
        <span class="c1"># -- self.model.prior_dict: RVs for weights, biases and Koopman K</span>
        <span class="c1"># -- self.model.hpp_dict: RVs for the variance of the above RVs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">construct_model</span><span class="p">()</span>

        <span class="c1"># passing the auxiliary placeholder for general loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">z_rec_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">z_lin_loss</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># passing variational posteriori to this class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">vp_dict</span>

        <span class="c1"># transfer the session to this model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sess</span>

        <span class="c1"># transfer graph to this model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">graph</span>

        <span class="c1"># verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">edward_configDict</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

        <span class="c1"># mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">edward_configDict</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>

        <span class="c1"># mode on whether or not using LRAN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LRAN_mode</span> <span class="o">=</span> <span class="n">LRAN_mode</span>

        <span class="c1"># directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dir</span>

        <span class="c1"># mc sample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_sample</span> <span class="o">=</span> <span class="n">mc_sample</span>

        <span class="c1"># initialization mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span> <span class="o">=</span> <span class="n">edward_configDict</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span> <span class="o">=</span> <span class="n">edward_configDict</span><span class="p">[</span><span class="s1">&#39;MAP_dir&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span> <span class="o">=</span> <span class="n">edward_configDict</span><span class="p">[</span><span class="s1">&#39;init_std_softplus&#39;</span><span class="p">]</span>

        <span class="c1"># optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;adam&#39;</span>

<div class="viewcode-block" id="ClassBayesDLKoopman.set_up_K_from_vpdict"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman.set_up_K_from_vpdict">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_K_from_vpdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get K variational posteriori distribution from :attr:`vp_dict` &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;nsd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># anti-symmetric and diagonal parameterization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;K_K_X&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;K_K_X&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;K_SD&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;K_SD&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use full matrix of K</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]}</span></div>

<div class="viewcode-block" id="ClassBayesDLKoopman.set_VI"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman.set_VI">[docs]</a>    <span class="k">def</span> <span class="nf">set_VI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set up variational inference with likelihood, priors, so we can infer posterior later&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                    <span class="c1"># MAPSimple: setup likelihood with fixed noise</span>

                    <span class="n">output_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">koopman_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRAN_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set up VI... with differential form&#39;</span><span class="p">)</span>
                        <span class="n">total_likelihood_size</span> <span class="o">=</span> <span class="n">output_size</span> <span class="o">+</span> <span class="n">koopman_size</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set up VI... with recurrent form&#39;</span><span class="p">)</span>
                        <span class="n">total_likelihood_size</span> <span class="o">=</span> <span class="n">output_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span>  <span class="n">koopman_size</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># build up a likelihood for general type of loss</span>
                    <span class="c1"># with fixed noise variance as 0.001</span>

                    <span class="n">Z_noise_std</span> <span class="o">=</span> <span class="mf">1e-3</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current mode = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="s1">&#39; noise std = &#39;</span><span class="p">,</span> <span class="n">Z_noise_std</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">MultivariateNormalDiag</span><span class="p">(</span>
                        <span class="n">loc</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                        <span class="n">scale_diag</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">Z_noise_std</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">total_likelihood_size</span><span class="p">,</span>
                                                                              <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">))</span>

                    <span class="c1"># link prior with PointMass VP</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c1"># 1. link prior_dict &lt;--&gt; vp_dict</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prior_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;prior-vp pair linking... &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prior_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="c1"># save printing to file</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;/cfg_advi_posteriori.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;Total number of pairs of VI: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;VI has been set: with variational posteriori as:&#39;</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">vp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;name = &#39;</span><span class="p">,</span> <span class="n">vp</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;shape = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">vp</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;posterior = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">vp</span><span class="p">]</span>

                    <span class="c1"># setup MAP inference</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">MAP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">})</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVInoARD&#39;</span><span class="p">:</span>

                    <span class="c1"># ADVInoARD: setup likelihood with fixed likelihood noise</span>

                    <span class="n">ADVInoARD_noise_scale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span>

                    <span class="n">output_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">koopman_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRAN_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set up VI... with differential form&#39;</span><span class="p">)</span>
                        <span class="n">total_likelihood_size</span> <span class="o">=</span> <span class="n">output_size</span> <span class="o">+</span> <span class="n">koopman_size</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set up VI... with recurrent form&#39;</span><span class="p">)</span>
                        <span class="n">total_likelihood_size</span> <span class="o">=</span> <span class="n">output_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span>  <span class="n">koopman_size</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># build up a likelihood for general type of loss</span>
                    <span class="c1"># with fixed noise variance</span>
                    <span class="c1"># small fixed noise forces to fit the data well.</span>

                    <span class="n">error_z_loc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss</span><span class="p">],</span>
                                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;error_z_loc&#39;</span><span class="p">)</span>

                    <span class="c1"># likelihoood is simply a 0.001^2 variance...</span>

                    <span class="n">error_z_scale</span> <span class="o">=</span> <span class="n">ADVInoARD_noise_scale</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">total_likelihood_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current mode = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="s1">&#39; noise std = &#39;</span><span class="p">,</span> <span class="n">ADVInoARD_noise_scale</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">MultivariateNormalDiag</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">error_z_loc</span><span class="p">,</span> <span class="n">scale_diag</span><span class="o">=</span><span class="n">error_z_scale</span><span class="p">)</span>

                    <span class="c1"># 5. construct the inference</span>
                    <span class="c1"># -- link prior: prior_dict, hpp_dict &lt;--&gt; vp_dict</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="c1"># -- 1. link prior_dict &lt;--&gt; vp_dict</span>

                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prior_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;prior-vp pair linking... &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prior_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="c1"># save printing to file</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;/cfg_advi_posteriori.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;Total number of pairs of VI: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;VI has been set: with variational posteriori as:&#39;</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">vp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;name = &#39;</span><span class="p">,</span> <span class="n">vp</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;shape = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">vp</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;posterior = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">vp</span><span class="p">]</span>

                    <span class="c1"># 6. set up the reparameterization part</span>
                    <span class="c1"># -- set the new data as auxilary data, we will regard that as our likelihood.</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">ReparameterizationKLqp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">})</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVIARD&#39;</span><span class="p">:</span>

                    <span class="c1"># 1. set up prior for noise variance in the likelihood of</span>
                    <span class="c1"># -- reconstruction</span>
                    <span class="c1"># -- linear dynamics</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRAN_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set up VI... with differential form&#39;</span><span class="p">)</span>
                        <span class="n">output_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">koopman_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;set up VI... with recurrent form&#39;</span><span class="p">)</span>
                        <span class="n">output_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">koopman_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;structureEncoder&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># setup noise prior for rec and linear error as `HalfCauchy`</span>
                    <span class="n">noise_rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_create_half_cauchy_prior</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ALPHA_HPP</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                                                                      <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">BETA_HPP</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">))</span>

                    <span class="n">noise_linear_koopman</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_create_half_cauchy_prior</span><span class="p">(</span>
                                                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ALPHA_HPP</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">koopman_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                                                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">BETA_HPP</span><span class="p">]</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">koopman_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">))</span>

                    <span class="c1"># 2. construct the final likelihood</span>
                    <span class="c1"># -- residual of reconstruction  ~ N(0, noise_rec)</span>
                    <span class="c1"># -- residual of linear dynamics ~ N(0, noise_linear_koopman)</span>
                    <span class="n">error_z_loc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss</span><span class="p">],</span>
                                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;error_z_loc&#39;</span><span class="p">)</span>
                    <span class="n">error_z_scale</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noise_rec</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noise_linear_koopman</span><span class="p">)],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;error_z_scale&#39;</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error_z_loc = &#39;</span><span class="p">,</span> <span class="n">error_z_loc</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error_z_scale = &#39;</span><span class="p">,</span> <span class="n">error_z_scale</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">MultivariateNormalDiag</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">error_z_loc</span><span class="p">,</span> <span class="n">scale_diag</span><span class="o">=</span><span class="n">error_z_scale</span><span class="p">)</span>


                    <span class="c1"># 3. (ALREADY SETUP) variational posteriori in self.vp_dict</span>
                    <span class="c1"># -- q w</span>
                    <span class="c1"># -- q b</span>
                    <span class="c1"># -- q K</span>
                    <span class="c1"># -- q scale w</span>
                    <span class="c1"># -- q scale b</span>
                    <span class="c1"># -- q scale K</span>

                    <span class="c1"># 4. variational posteriori in likelihood variance:</span>
                    <span class="c1"># note that it is applying softplus scale already! we use log normal</span>
                    <span class="c1"># also note that it is a positive support distribution, since it use exp to map to R+</span>

                    <span class="c1"># -- qnoise_rec</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;scale_noise_rec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                        <span class="n">distribution</span><span class="o">=</span><span class="n">ed</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">NormalWithSoftplusScale</span><span class="p">(</span>
                            <span class="n">loc</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;scale_noise_rec/loc&#39;</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">,</span>
                                                <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                            <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;scale_noise_rec/scale&#39;</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">,</span>
                                                  <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                                                  <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)),</span>
                        <span class="n">bijector</span><span class="o">=</span><span class="n">bijectors</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_noise_rec&#39;</span><span class="p">)</span>

                    <span class="c1"># -- qnoise_linear_koopman</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;scale_noise_lin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
                        <span class="n">distribution</span><span class="o">=</span><span class="n">ed</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">NormalWithSoftplusScale</span><span class="p">(</span>
                            <span class="n">loc</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;scale_noise_lin/loc&#39;</span><span class="p">,</span> <span class="n">koopman_shape</span><span class="p">,</span>
                                                <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                                                <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                            <span class="n">scale</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;scale_noise_lin/scale&#39;</span><span class="p">,</span> <span class="n">koopman_shape</span><span class="p">,</span>
                                                  <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">constant_initializer</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">),</span>
                                                  <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)),</span>
                        <span class="n">bijector</span><span class="o">=</span><span class="n">bijectors</span><span class="o">.</span><span class="n">Exp</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_noise_linear_koopman&#39;</span><span class="p">)</span>

                    <span class="c1"># 5. construct the inference</span>
                    <span class="c1"># -- link prior: prior_dict, hpp_dict &lt;--&gt; vp_dict</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># -- 1. link prior_dict &lt;--&gt; vp_dict</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prior_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;prior-vp pair linking... &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">prior_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="c1"># -- 2. link hpp_dict &lt;--&gt; vp_dict</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hpp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;layer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hyp-prior-vp pair linking... &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">hpp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;scale_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span>
                    <span class="c1"># -- 3. link the noise term with the corresponding VP</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">[</span><span class="n">noise_rec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;scale_noise_rec&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">[</span><span class="n">noise_linear_koopman</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="s1">&#39;scale_noise_lin&#39;</span><span class="p">]</span>

                    <span class="c1"># save printing to file</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s2">&quot;/cfg_advi.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;Total number of pairs of VI: &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">)</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;VI has been set: with variational posteriori as:&#39;</span>
                        <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">vp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;prior = &#39;</span><span class="p">,</span> <span class="n">vp</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;shape = &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">vp</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                            <span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span> <span class="s1">&#39;posterior = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vp_dict</span><span class="p">[</span><span class="n">vp</span><span class="p">]</span>

                    <span class="c1"># 6. set up the reparameterization part</span>
                    <span class="c1"># -- set the new data as auxilary data, we will regard that as our likelihood.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">ReparameterizationKLqp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">})</span>

                <span class="c1"># 7. set up a tensor to evaluate the residual from VP</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z_post</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss_post</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss_post</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassBayesDLKoopman.choose_optimizer"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman.choose_optimizer">[docs]</a>    <span class="k">def</span> <span class="nf">choose_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;choose the optimizer given optimizer names</span>

<span class="sd">        Note:</span>

<span class="sd">            1. `adam`</span>
<span class="sd">            2. `adadelta`</span>
<span class="sd">            3. `adagrad`</span>
<span class="sd">            4. `momentum`</span>
<span class="sd">            5. `ftrl`</span>
<span class="sd">            6. `rmsprop`</span>

<span class="sd">        Args:</span>
<span class="sd">            optimizer_name (:obj:`str`): the string for optimizer to choose.</span>

<span class="sd">        Returns:</span>

<span class="sd">            :obj:`class` : optimizer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>

                <span class="c1"># &#39;adadelta&#39;:</span>
                <span class="c1"># &#39;adagrad&#39;:</span>
                <span class="c1"># &#39;momentum&#39;:</span>
                <span class="c1"># &#39;adam&#39;:</span>
                <span class="c1"># &#39;ftrl&#39;:</span>
                <span class="c1"># &#39;rmsprop&#39;:</span>

                <span class="k">if</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>

                    <span class="c1"># optimizer = L4.L4Adam(fraction=0.2)</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">],</span>
                        <span class="n">epsilon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;decay&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdadeltaOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;adagrad&#39;</span><span class="p">:</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdagradOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;momentum&#39;</span><span class="p">:</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">MomentumOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">],</span>
                        <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                        <span class="n">use_nesterov</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;ftrl&#39;</span><span class="p">:</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FtrlOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">])</span>

                <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s1">&#39;rmsprop&#39;</span><span class="p">:</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">RMSPropOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;learningRate&#39;</span><span class="p">],</span>
                        <span class="n">epsilon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;decay&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">optimizer</span></div>


<div class="viewcode-block" id="ClassBayesDLKoopman.train"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;training for the Bayesisan DL Koopman model</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`list` : total MSE list.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># we set up the K variatioal posteriori from the :attr:`vp_dict`.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_up_K_from_vpdict</span><span class="p">()</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LRAN_mode</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="c1"># differential form Bayesian KOopman</span>

                    <span class="c1"># using minibatch training for the KLqp</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">edwardMBTrainer</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                                                   <span class="n">inference</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span>
                                                   <span class="n">n_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;numberEpoch&#39;</span><span class="p">],</span>
                                                   <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_sample</span><span class="p">,</span>
                                                   <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;miniBatch&#39;</span><span class="p">],</span>
                                                   <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                                                   <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                                                   <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Xdot</span><span class="p">,</span>
                                                   <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>  <span class="c1"># likelihood RV</span>
                                                   <span class="n">z_ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">,</span>  <span class="c1"># placeholder to let data flow in from true</span>
                                                   <span class="n">z_post</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="p">,</span>  <span class="c1"># placeholder to compute MSE</span>
                                                   <span class="n">logstr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;/log&#39;</span><span class="p">,</span>
                                                   <span class="n">sess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span>
                                                   <span class="n">K</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                                                   <span class="n">init_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span><span class="p">,</span>
                                                   <span class="n">init_std_softplus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">,</span>
                                                   <span class="n">MAP_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span><span class="p">,</span>
                                                   <span class="n">residual_lin_loss_post</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss_post</span><span class="p">,</span>
                                                   <span class="n">residual_rec_loss_post</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss_post</span><span class="p">,</span>
                                                   <span class="n">nsd_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;nsd&#39;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">initilize</span><span class="p">()</span>

                    <span class="c1"># using validation data as testing data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">x_test</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Xvalid</span><span class="p">,</span>
                                          <span class="n">y_train</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">XdotTrain</span><span class="p">,</span> <span class="n">y_test</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">XdotValid</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># recurrent form Bayesian Koopman</span>

                    <span class="c1"># using minibatch training for the KLqp</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">edwardMBTrainerLRAN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
                                                       <span class="n">inference</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">,</span>
                                                       <span class="n">n_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;numberEpoch&#39;</span><span class="p">],</span>
                                                       <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_sample</span><span class="p">,</span>
                                                       <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;miniBatch&#39;</span><span class="p">],</span>
                                                       <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                                                       <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                                                       <span class="n">future_X_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">future_X_list</span><span class="p">,</span>
                                                       <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>  <span class="c1"># likelihood RV</span>
                                                       <span class="n">z_ph</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">,</span>  <span class="c1"># placeholder to let data flow in from true</span>
                                                       <span class="n">z_post</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="p">,</span>  <span class="c1"># placeholder to compute MSE</span>
                                                       <span class="n">logstr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">+</span> <span class="s1">&#39;/log&#39;&#39;log&#39;</span><span class="p">,</span>
                                                       <span class="n">sess</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span>
                                                       <span class="n">K</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span>
                                                       <span class="n">init_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span><span class="p">,</span>
                                                       <span class="n">init_std_softplus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">,</span>
                                                       <span class="n">MAP_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span><span class="p">,</span>
                                                       <span class="n">residual_lin_loss_post</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_lin_loss_post</span><span class="p">,</span>
                                                       <span class="n">residual_rec_loss_post</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_vector_rec_loss_post</span><span class="p">,</span>
                                                       <span class="n">nsd_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;nsd&#39;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">initilize</span><span class="p">()</span>

                    <span class="c1"># using validation data as testing data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_train</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">x_future_train</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">XfutureTrain</span><span class="p">,</span>
                                          <span class="n">x_valid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Xvalid</span><span class="p">,</span> <span class="n">x_future_valid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">XfutureValid</span><span class="p">)</span>

                <span class="c1"># start to training in a minibatch fashion</span>
                <span class="n">total_MSE_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">minibatch_train</span><span class="p">()</span>

                <span class="c1"># print &#39;total_MSE_list =&#39;, total_MSE_list</span>

        <span class="k">return</span> <span class="n">total_MSE_list</span></div>

<div class="viewcode-block" id="ClassBayesDLKoopman.update_graph"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman.update_graph">[docs]</a>    <span class="k">def</span> <span class="nf">update_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sess</span></div>

<div class="viewcode-block" id="ClassBayesDLKoopman.save_model"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.ClassBayesDLKoopman.save_model">[docs]</a>    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save model calling the ``save_model`` function in ``ClassDLKoopmanCont`` or</span>
<span class="sd">        ``classDLKoopmanLRAN`` &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="c1"># saving mode using DL Koopman</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save_model</span><span class="p">()</span></div></div>













<div class="viewcode-block" id="edwardMBTrainer"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainer">[docs]</a><span class="k">class</span> <span class="nc">edwardMBTrainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class of calling ``edward`` to do ADVI for ``differential form``.</span>

<span class="sd">    Args:</span>

<span class="sd">        mode (:obj:`str`): Selecting the the type of MFVI framework to use.</span>

<span class="sd">        inference (:obj:`class`): ``edward.Inference`` class instance. It is the main object for variational inference.</span>

<span class="sd">        n_epoch (:obj:`int`): number of epoch.</span>

<span class="sd">        n_samples (:obj:`int`): number of total sampling training data.</span>

<span class="sd">        batch_size (:obj:`int`): batch size for mini-batch training.</span>

<span class="sd">        optimizer (:obj:`class`): an optimizer for training. ``tf.train.Adam`` can also be used.</span>

<span class="sd">        x (:obj:`tf.Tensor`): placeholder for feeding the input data, i.e., :math:`x`.</span>

<span class="sd">        y (:obj:`tf.Tensor`): placeholder for feeding the input data, i.e., :math:`\dot{x}`.</span>

<span class="sd">        z (:obj:`tf.Tensor`): likelihood tensor just to construct the graph.</span>

<span class="sd">        z_ph (:obj:`tf.Tensor`): placeholder for feeding the likelihood, i.e., zeros.</span>

<span class="sd">        z_post (:obj:`tf.Tensor`): after copying the posteriori to the true parameters, this is the output placeholder</span>
<span class="sd">            that enables one to evaluate the output of the z.</span>

<span class="sd">        logstr (:obj:`str`): the path to write logs from Edward. Not used anymore.</span>

<span class="sd">        sess(:obj:`class`): A context manager using this session as the default session.</span>

<span class="sd">        K (:obj:`tf.Tensor`): Feed the tensor ``K`` matrix.</span>

<span class="sd">        init_mode (:obj:`str`): The mode we choose to initialize the process of AVDI.</span>

<span class="sd">        init_std_softplus (:obj:`float`): the initial standard deviation we used in softplus, the more negative,</span>
<span class="sd">            the smaller it is.</span>

<span class="sd">        MAP_dir (:obj:`str`): path to the pre-trained model when :attr:`init_mode` = ``nonBayes``.</span>

<span class="sd">        residual_lin_loss_post (:obj:`tf.Tensor`): linear dynamics residuals from model construction in the</span>
<span class="sd">            class ``ClassDLKoopmanCont`` defined at :ref:`ClassDLKoopmanCont`.</span>

<span class="sd">        residual_rec_loss_post (:obj:`tf.Tensor`): reconstruction dynamics residuals from model construction in the</span>
<span class="sd">            class ``ClassDLKoopmanCont`` defined at :ref:`ClassDLKoopmanCont`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        sess (:obj:`class`): A context manager using this session as the default session.</span>

<span class="sd">        graph (:obj:`class`): A `Graph` instance supports an arbitrary number of “collections” that are identified by name.</span>

<span class="sd">        mode (:obj:`str`): Selecting the the type of MFVI framework to use.</span>

<span class="sd">            Note:</span>
<span class="sd">                * ADVInoARD</span>
<span class="sd">                * ADVIARD</span>
<span class="sd">                * MAPSimple</span>

<span class="sd">        inference (:obj:`class`): ``edward.Inference`` class instance. It is the main object for variational inference.</span>

<span class="sd">        n_epoch (:obj:`int`): number of epoch.</span>

<span class="sd">        n_samples (:obj:`int`): number of total sampling training data.</span>

<span class="sd">        batch_size (:obj:`int`): batch size for mini-batch training.</span>

<span class="sd">        optimizer (:obj:`class`): an optimizer for training. ``tf.train.Adam`` can also be used.</span>

<span class="sd">        logstr (:obj:`str`): the path to write logs from Edward. Not used anymore.</span>

<span class="sd">        x (:obj:`tf.Tensor`): placeholder for feeding the input data, i.e., :math:`x`.</span>

<span class="sd">        y (:obj:`tf.Tensor`): placeholder for feeding the input data, i.e., :math:`\dot{x}`.</span>

<span class="sd">        z (:obj:`tf.Tensor`): likelihood tensor just to construct the graph.</span>

<span class="sd">        z_ph (:obj:`tf.Tensor`): placeholder for feeding the likelihood, i.e., zeros.</span>

<span class="sd">        z_post (:obj:`tf.Tensor`): after copying the posteriori to the true parameters, this is the output placeholder</span>
<span class="sd">            that enables one to evaluate the output of the z.</span>

<span class="sd">        K (:obj:`dict`): A collection with keys as``K_K_X`` and ``K_SD`` to map to the probability distribution of those two components. Here we only assume the stabilization form.</span>

<span class="sd">        init_mode (:obj:`str`): The mode we choose to initialize the process of AVDI.</span>

<span class="sd">            Note:</span>

<span class="sd">                * ``Standard``</span>
<span class="sd">                    simply initialize the weights just variance-scaling method, with scale initialized very small.</span>
<span class="sd">                * ``nonBayes``</span>
<span class="sd">                    simply initialize with a fined-tuned deterministic result. This is helpful for training the case of the Duffing oscillator.</span>

<span class="sd">        init_std_softplus (:obj:`float`): the initial standard deviation we used in softplus, the more negative ,</span>
<span class="sd">            the smaller it is.</span>

<span class="sd">        MAP_dir (:obj:`str`): path to the pre-trained model when :attr:`init_mode` = ``nonBayes``.</span>

<span class="sd">        residual_lin_loss_post (:obj:`tf.Tensor`): linear dynamics residuals from model construction in the</span>
<span class="sd">           class ``ClassDLKoopmanCont`` defined at :ref:`ClassDLKoopmanCont`.</span>

<span class="sd">        residual_rec_loss_post (:obj:`tf.Tensor`): reconstruction dynamics residuals from model construction in the</span>
<span class="sd">           class ``ClassDLKoopmanCont`` defined at :ref:`ClassDLKoopmanCont`.</span>

<span class="sd">        n_data (:obj:`int`): number of training data.</span>

<span class="sd">        x_train (:obj:`numpy.ndarray`): training states.</span>

<span class="sd">        y_train (:obj:`numpy.ndarray`): training time derivative.</span>

<span class="sd">        x_test (:obj:`numpy.ndarray`): testing states.</span>

<span class="sd">        y_test (:obj:`numpy.ndarray`): testing time derivative.</span>

<span class="sd">        z_train (:obj:`numpy.ndarray`): feeding training likelihood data, i.e., zeros.</span>

<span class="sd">        z_test (:obj:`numpy.ndarray`): feediing testing likelihood data, i.e., zeros.</span>

<span class="sd">        data (:obj:`generator`): a generator for getting mini-batch training data.</span>

<span class="sd">        n_batch (:obj:`int`): number of batches in the total training data.</span>




<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">inference</span><span class="p">,</span> <span class="n">n_epoch</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
                 <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z_ph</span><span class="p">,</span> <span class="n">z_post</span><span class="p">,</span> <span class="n">logstr</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span>
                 <span class="n">init_mode</span><span class="p">,</span> <span class="n">init_std_softplus</span><span class="p">,</span> <span class="n">MAP_dir</span><span class="p">,</span>
                 <span class="n">residual_lin_loss_post</span><span class="p">,</span> <span class="n">residual_rec_loss_post</span><span class="p">,</span>
                 <span class="n">nsd_mode</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">graph</span>

        <span class="c1"># with self.graph.as_default():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">inference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span> <span class="o">=</span> <span class="n">n_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logstr</span> <span class="o">=</span> <span class="n">logstr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">=</span> <span class="n">nsd_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># for mean evaluation</span>

        <span class="c1"># input placeholder --&gt; feed training feature in</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="c1"># likelihood tensor --&gt; to construct the graph</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>

        <span class="c1"># output placeholder --&gt; feed training target in</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span> <span class="o">=</span> <span class="n">z_ph</span>

        <span class="c1"># tensor for evaluating the error of residual</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z_post</span> <span class="o">=</span> <span class="n">z_post</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span> <span class="o">=</span> <span class="n">init_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span> <span class="o">=</span> <span class="n">init_std_softplus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span> <span class="o">=</span> <span class="n">MAP_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">residual_lin_loss_post</span> <span class="o">=</span> <span class="n">residual_lin_loss_post</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_rec_loss_post</span> <span class="o">=</span> <span class="n">residual_rec_loss_post</span>

        <span class="c1"># create log file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logstr</span> <span class="o">+</span> <span class="s1">&#39;.txt-bayesian&#39;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="edwardMBTrainer.generator"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainer.generator">[docs]</a>    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator for mini-batches</span>

<span class="sd">        The batches are generated with respect to each array&#39;s first axis.</span>

<span class="sd">        Examples:</span>

<span class="sd">            ::</span>

<span class="sd">                self.data = self.generator([self.x_train, self.y_train], self.batch_size)</span>


<span class="sd">        Args:</span>
<span class="sd">            arrays (:obj:`numpy.ndarray`): training data with first axis as number of samples.</span>

<span class="sd">            batch_size (:obj:`int`): batch size in order to divide data to get mini-batches generator.</span>

<span class="sd">        Yield:</span>
<span class="sd">            :obj:`numpy.ndarray` : next batch size data.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>  <span class="c1"># pointers to where we are in iteration</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">batch_size</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
                    <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:],</span> <span class="n">array</span><span class="p">[:</span><span class="n">diff</span><span class="p">]))</span>
                    <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span>
                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">batches</span></div>

<div class="viewcode-block" id="edwardMBTrainer.set_data"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainer.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up data for variational inference process.</span>

<span class="sd">        Args:</span>

<span class="sd">            x_train (:obj:`numpy.ndarray`): training states, i.e., :math:`x`.</span>

<span class="sd">            y_train (:obj:`numpy.ndarray`): training time derivative, i.e., :math:`\dot{x}`</span>

<span class="sd">            x_test (:obj:`numpy.ndarray`): testing states</span>

<span class="sd">            y_test (:obj:`numpy.ndarray`): testing time derivative</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span>

        <span class="c1"># adding z_test auxially variables.</span>
        <span class="c1"># Note:</span>
        <span class="c1">#   they are zeros</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># minibatch generator from training data pairs.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># number of batches in the training data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span></div>

<div class="viewcode-block" id="edwardMBTrainer.sample_K_and_return_mean"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainer.sample_K_and_return_mean">[docs]</a>    <span class="k">def</span> <span class="nf">sample_K_and_return_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MC sampling the variational posteriori for Koopman operator ``K`` then return the mean.</span>

<span class="sd">        We just do a Monte carlo sampling with number as :attr:`mc_samples`. Default value as 100.</span>
<span class="sd">        Note that we simply assumes we using the stabilized form.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            mc_samples (:obj:`int`): number of Monte carlo samples for getting ``K``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`numpy.ndarray` : mean Koopman operator matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># getting the probability distribution from :attr:`K`.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">K_K_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="s1">&#39;K_K_X&#39;</span><span class="p">]</span>
            <span class="n">K_SD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="s1">&#39;K_SD&#39;</span><span class="p">]</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">samples_X_upper</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_band_part</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">K_K_X</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">samples_K_XX</span> <span class="o">=</span> <span class="n">samples_X_upper</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">samples_X_upper</span><span class="p">)</span>
                <span class="n">samples_K_SD</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">K_SD</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">samples_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples_K_XX</span> <span class="o">-</span> <span class="n">samples_K_SD</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">samples_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">samples_K</span></div>

<div class="viewcode-block" id="edwardMBTrainer.minibatch_train"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainer.minibatch_train">[docs]</a>    <span class="k">def</span> <span class="nf">minibatch_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mini-batch training function</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`list` : total MSE list</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>

                <span class="c1"># the scaling is to cheat on the optimizer to make it feels like seeing a whole set of data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                                              <span class="n">n_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">,</span>
                                              <span class="n">scale</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">*</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">TF_FLOAT</span><span class="p">)},</span>
                                              <span class="n">logdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">auto_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                                              <span class="n">n_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">,</span>
                                              <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                                              <span class="n">scale</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">*</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">TF_FLOAT</span><span class="p">)},</span>
                                              <span class="n">logdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">auto_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1">## initialize the encoder, decoder, K as well</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span> <span class="o">==</span> <span class="s1">&#39;Standard&#39;</span><span class="p">:</span>

                    <span class="nb">print</span> <span class="s1">&#39;ADVI initialized in the classical way (no pre-trained parameters)&#39;</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="nb">print</span> <span class="s1">&#39;ADVI initialized in nonBayes: for K, encoder, decoder&#39;</span>

                    <span class="c1"># still initlize other things</span>

                    <span class="n">para_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span> <span class="o">+</span> <span class="s1">&#39;/saved_para.npy&#39;</span><span class="p">)</span>
                    <span class="n">para_dict</span> <span class="o">=</span> <span class="n">para_dict</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                    <span class="c1"># use tf.assign for the loc in K, decoder, encoder</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">para_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                        <span class="nb">print</span> <span class="s1">&#39;key = &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39; is initialized manually! &#39;</span>

                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                <span class="c1"># first consider the K_X part</span>
                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_K_X/loc:0&#39;</span><span class="p">)</span>

                                <span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">tv</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                                <span class="c1"># get the full K from the nonBayes result</span>
                                <span class="n">K</span> <span class="o">=</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;validating the pretrained K...&#39;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;eig of K = &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">K</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                                <span class="c1"># get K&#39;s upper diagonal</span>
                                <span class="n">K_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">K_K_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">K_upper</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;K = &#39;</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;K_K_X should be only the offset of K&#39;</span><span class="p">,</span> <span class="n">K_K_X</span><span class="p">)</span>

                                <span class="c1"># get K&#39;s diagonal, but it is a minius one...</span>
                                <span class="n">K_SD</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                                <span class="c1"># assign the nonBayes K_K_X to the Bayes</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">K_K_X</span><span class="p">))</span>

                                <span class="c1"># assign the nonBayes positive square diagonal part to SD part</span>
                                <span class="c1"># Note that qK_SD/loc:0 is inside a lognormal, so one need  to take a log</span>
                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_SD/loc:0&#39;</span><span class="p">)</span>

                                <span class="c1"># prevent nan</span>
                                <span class="n">K_SD</span> <span class="o">+=</span> <span class="mf">1e-6</span>

                                <span class="c1"># Becase K_SD is vari-posterioed with a log normal</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">K_SD</span><span class="p">)))</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="c1"># if full matrix K is used</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK/loc:0&#39;</span><span class="p">)</span>

                                <span class="n">K</span> <span class="o">=</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>

                            <span class="c1"># Now consider the assigning ``scale`` part --&gt; make them small</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                                <span class="k">pass</span>

                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVInoARD&#39;</span><span class="p">:</span>

                                <span class="c1"># Here, we force initial scale to be quite negative, note that</span>
                                <span class="c1"># all the scale parameter is transformed by a softmax to make it positive, so we just assign</span>
                                <span class="c1"># very negative to make the variance of posteriori extremely small.</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_K_X/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_SD/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="k">else</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVIARD&#39;</span><span class="p">:</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_K_X/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_SD/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_K_X/loc:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_K_X/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_SD/loc:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_SD/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="k">else</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="c1">## now let&#39;s put the rest: encoder and decoder weights</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc:0&#39;</span><span class="p">)</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>


                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVInoARD&#39;</span><span class="p">:</span>

                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;use pretrained weight and biases...&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc:0&#39;</span><span class="p">)</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

                                <span class="c1"># debug: reduce stddev initial to zero</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/scale:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>


                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVIARD&#39;</span><span class="p">:</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc_1:0&#39;</span><span class="p">)</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/scale_1:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="c1"># make sure the scale in prior is also near zero, which means prior is like a point mass</span>
                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscale_&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscale_&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/scale:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="c1"># tv = self.graph.get_tensor_by_name(key + &#39;/loc_1:0&#39;)</span>
                                <span class="c1">#</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="c1">#</span>
                                <span class="c1"># self.sess.run(tf.assign(tv, para_dict[key]))</span>
                                <span class="c1">#</span>
                                <span class="c1"># # debug: reduce stddev initial to zero</span>
                                <span class="c1"># tv = self.graph.get_tensor_by_name(key + &#39;/scale_1:0&#39;)</span>
                                <span class="c1">#</span>
                                <span class="c1"># self.sess.run(tf.assign(tv, tf.ones(tv.get_shape()) * self.init_std_softplus))</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

                <span class="c1">## before training, check initial error</span>
                <span class="n">res_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span><span class="p">})</span>
                <span class="n">train_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="n">res_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_test</span><span class="p">})</span>
                <span class="n">valid_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_lin_loss_post</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span><span class="p">})</span>

                <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_rec_loss_post</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span><span class="p">})</span>

                <span class="nb">print</span> <span class="s1">&#39;MAP train_MSE = &#39;</span><span class="p">,</span> <span class="n">train_MSE</span>
                <span class="nb">print</span> <span class="s1">&#39;MAP valid_MSE = &#39;</span><span class="p">,</span> <span class="n">valid_MSE</span>


                <span class="c1">## batch training begin</span>
                <span class="n">tot_batch_loss</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">train_MSE_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">valid_MSE_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">n_iter</span><span class="p">):</span>

                    <span class="c1">## each iteration is processing one batch</span>

                    <span class="c1"># generates the batch!!!</span>
                    <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                    <span class="c1">## update with the data!</span>
                    <span class="c1">## it is feeding both X and y</span>
                    <span class="c1"># info_dict = self.inference.update({x: X_batch, y_ph: y_batch})</span>

                    <span class="c1">## change it with the generalized loss</span>
                    <span class="n">z_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span> <span class="n">y_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="p">))</span>
                    <span class="n">info_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="n">X_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">y_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="n">z_batch</span><span class="p">})</span>

                    <span class="c1"># inference.print_progress(info_dict)</span>

                    <span class="c1"># summing loss</span>
                    <span class="n">tot_batch_loss</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

                    <span class="c1"># then we finished with epoch</span>
                    <span class="k">if</span> <span class="n">_</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                        <span class="n">res_train_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span><span class="p">})</span>
                        <span class="n">train_MSE_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_train_mean</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="n">res_test_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_test</span><span class="p">})</span>
                        <span class="n">valid_MSE_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_test_mean</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="n">res_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="p">,</span>
                                                  <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_train</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span><span class="p">})</span>
                        <span class="n">train_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="n">res_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="p">,</span>
                                                 <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_test</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_test</span><span class="p">})</span>
                        <span class="n">valid_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="c1"># train_MSE = ed.evaluate(&#39;mean_squared_error&#39;,</span>
                        <span class="c1">#                                   data={self.x: self.x_train,</span>
                        <span class="c1">#                                         self.y: self.y_train,</span>
                        <span class="c1">#                                         self.z_post: self.z_train})</span>
                        <span class="c1">#</span>
                        <span class="c1"># valid_MSE = ed.evaluate(&#39;mean_squared_error&#39;,</span>
                        <span class="c1">#                                  data={self.x: self.x_test,</span>
                        <span class="c1">#                                        self.y: self.y_test,</span>
                        <span class="c1">#                                        self.z_post: self.z_test})</span>

                        <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;current epoch = &#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span><span class="p">),</span> <span class="s1">&#39; total epoch = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span>
                        <span class="nb">print</span> <span class="s1">&#39;mean of error residual = &#39;</span><span class="p">,</span> <span class="n">train_MSE_mean</span><span class="p">,</span> <span class="n">valid_MSE_mean</span>
                        <span class="nb">print</span> <span class="s1">&#39;train MSE = &#39;</span><span class="p">,</span> <span class="n">train_MSE</span>
                        <span class="nb">print</span> <span class="s1">&#39;validation MSE = &#39;</span><span class="p">,</span> <span class="n">valid_MSE</span>

                        <span class="c1">## evaluate the Koopman eigenvalues for the mean of the Koopman operator</span>

                        <span class="c1"># sample K to get mean value</span>
                        <span class="n">K_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_K_and_return_mean</span><span class="p">()</span>
                        <span class="n">evalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">K_mean</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="nb">print</span> <span class="s1">&#39;eigenvalues = &#39;</span><span class="p">,</span> <span class="n">evalue</span>

                        <span class="c1">## write all the stuff into log so I can monitor them on cluster</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=============================================&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;current epoch = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; total epoch = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mean of error residual = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_MSE_mean</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">valid_MSE_mean</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;train MSE = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_MSE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;validation MSE = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">valid_MSE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;eigenvalues = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">evalue</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="n">train_MSE_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_MSE</span><span class="p">)</span>
                        <span class="n">valid_MSE_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_MSE</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_MSE_list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_MSE_list</span>

                <span class="c1"># end inference.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

                <span class="c1"># close loss log file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="c1"># print &#39;total_mse =&#39;, self.total_MSE_list</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span></div>

<div class="viewcode-block" id="edwardMBTrainer.get_graph"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainer.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span></div></div>


<div class="viewcode-block" id="edwardMBTrainerLRAN"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainerLRAN">[docs]</a><span class="k">class</span> <span class="nc">edwardMBTrainerLRAN</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class of calling ``edward`` to do ADVI for ``recurrent form``</span>

<span class="sd">    The only difference with :class:`edwardMBTrainer` is that :math:`\dot{x}` is not used and we use ``T`` as the time delay steps.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">inference</span><span class="p">,</span> <span class="n">n_epoch</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
                 <span class="n">x</span><span class="p">,</span> <span class="n">future_X_list</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z_ph</span><span class="p">,</span> <span class="n">z_post</span><span class="p">,</span> <span class="n">logstr</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span>
                 <span class="n">init_mode</span><span class="p">,</span> <span class="n">init_std_softplus</span><span class="p">,</span> <span class="n">MAP_dir</span><span class="p">,</span>
                 <span class="n">residual_lin_loss_post</span><span class="p">,</span> <span class="n">residual_rec_loss_post</span><span class="p">,</span>
                 <span class="n">nsd_mode</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">graph</span>

        <span class="c1"># with self.graph.as_default():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference</span> <span class="o">=</span> <span class="n">inference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span> <span class="o">=</span> <span class="n">n_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logstr</span> <span class="o">=</span> <span class="n">logstr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">=</span> <span class="n">nsd_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># for mean evaluation</span>

        <span class="c1"># input placeholder --&gt; feed training feature in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future_X_list</span> <span class="o">=</span> <span class="n">future_X_list</span>

        <span class="c1"># likelihood tensor --&gt; to construct the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>

        <span class="c1"># output placeholder --&gt; feed training target in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span> <span class="o">=</span> <span class="n">z_ph</span>

        <span class="c1"># tensor for evaluating the error of residual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_post</span> <span class="o">=</span> <span class="n">z_post</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span> <span class="o">=</span> <span class="n">init_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span> <span class="o">=</span> <span class="n">init_std_softplus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span> <span class="o">=</span> <span class="n">MAP_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_lin_loss_post</span> <span class="o">=</span> <span class="n">residual_lin_loss_post</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residual_rec_loss_post</span> <span class="o">=</span> <span class="n">residual_rec_loss_post</span>

        <span class="c1"># create log file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logstr</span> <span class="o">+</span> <span class="s1">&#39;.txt-bayesian-lran&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">return</span>

<div class="viewcode-block" id="edwardMBTrainerLRAN.generator"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainerLRAN.generator">[docs]</a>    <span class="k">def</span> <span class="nf">generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate batches, one with respect to each array&#39;s first axis.&quot;&quot;&quot;</span>
        <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>  <span class="c1"># pointers to where we are in iteration</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">batch_size</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
                    <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">batch_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:],</span> <span class="n">array</span><span class="p">[:</span><span class="n">diff</span><span class="p">]))</span>
                    <span class="n">starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span>
                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">batches</span></div>

<div class="viewcode-block" id="edwardMBTrainerLRAN.set_data"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainerLRAN.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">x_future_train</span><span class="p">,</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">x_future_valid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_valid</span> <span class="o">=</span> <span class="n">x_valid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_future_train</span> <span class="o">=</span> <span class="n">x_future_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_future_valid</span> <span class="o">=</span> <span class="n">x_future_valid</span>


        <span class="c1">## adding z_test auxially variables.</span>
        <span class="c1"># -- they are zeros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># minibatch generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_future_train</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span></div>

<div class="viewcode-block" id="edwardMBTrainerLRAN.sample_K_and_return_mean"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainerLRAN.sample_K_and_return_mean">[docs]</a>    <span class="k">def</span> <span class="nf">sample_K_and_return_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">K_K_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="s1">&#39;K_K_X&#39;</span><span class="p">]</span>
            <span class="n">K_SD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="s1">&#39;K_SD&#39;</span><span class="p">]</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">samples_X_upper</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matrix_band_part</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">K_K_X</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">samples_K_XX</span> <span class="o">=</span> <span class="n">samples_X_upper</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">samples_X_upper</span><span class="p">)</span>
                <span class="n">samples_K_SD</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">K_SD</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">samples_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples_K_XX</span> <span class="o">-</span> <span class="n">samples_K_SD</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
                <span class="n">samples_K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_samples</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">samples_K</span></div>

<div class="viewcode-block" id="edwardMBTrainerLRAN.minibatch_train"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainerLRAN.minibatch_train">[docs]</a>    <span class="k">def</span> <span class="nf">minibatch_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>


        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>

                <span class="c1"># the scaling is to cheat on the optimizer to make it feels like seeing a whole set of data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                                              <span class="n">n_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">,</span>
                                              <span class="n">scale</span><span class="o">=</span><span class="p">{</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">TF_FLOAT</span><span class="p">)},</span>
                                              <span class="n">logdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">auto_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                                              <span class="n">n_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">,</span>
                                              <span class="n">n_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">,</span>
                                              <span class="n">scale</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">},</span>
                                              <span class="n">logdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">auto_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1">## initialize the encoder, decoder, K as well</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_mode</span> <span class="o">==</span> <span class="s1">&#39;Standard&#39;</span><span class="p">:</span>

                    <span class="nb">print</span> <span class="s1">&#39;ADVI initialized in the standard way&#39;</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="nb">print</span> <span class="s1">&#39;ADVI initialized in nonBayes: for K, encoder, decoder&#39;</span>

                    <span class="c1"># still initlize other things</span>

                    <span class="n">para_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAP_dir</span> <span class="o">+</span> <span class="s1">&#39;/saved_para.npy&#39;</span><span class="p">)</span>
                    <span class="n">para_dict</span> <span class="o">=</span> <span class="n">para_dict</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                    <span class="c1"># use tf.assign for the loc in K, decoder, encoder</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">para_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                        <span class="nb">print</span> <span class="s1">&#39;key = &#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39; is initialized manually! &#39;</span>

                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                <span class="c1"># first consider the K_X part</span>
                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_K_X/loc:0&#39;</span><span class="p">)</span>

                                <span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">tv</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                                <span class="c1"># get the full K from the nonBayes result</span>
                                <span class="n">K</span> <span class="o">=</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                                <span class="c1"># get K&#39;s upper diagonal</span>
                                <span class="n">K_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">K_K_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">K_upper</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                                <span class="c1"># get K&#39;s diagonal, but it is a minius one...</span>
                                <span class="n">K_SD</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                                <span class="c1"># assign the nonBayes K_K_X to the Bayes</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">K_K_X</span><span class="p">))</span>

                                <span class="c1"># assign the nonBayes positive square diagonal part to SD part</span>
                                <span class="c1"># Note that qK_SD/loc:0 is inside a lognormal, so one need  to take a log</span>
                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_SD/loc:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">K_SD</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">))))</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK/loc:0&#39;</span><span class="p">)</span>
                                <span class="n">K</span> <span class="o">=</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>

                            <span class="c1"># Now consider the scale part</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                                <span class="k">pass</span>

                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVInoARD&#39;</span><span class="p">:</span>

                                <span class="c1"># Here, we force initial scale to be quite negative, note that</span>
                                <span class="c1"># all the scale parameter is transformed by a softmax to make it positive, so we just assign</span>
                                <span class="c1"># very negative to make the variance of posteriori extremely small.</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_K_X/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_SD/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="k">else</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVIARD&#39;</span><span class="p">:</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsd_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_K_X/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK_SD/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_K_X/loc:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_K_X/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_SD/loc:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscaleK_SD/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                        <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="k">else</span><span class="p">:</span>

                                    <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qK/scale:0&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="c1">## now let&#39;s put the rest: encoder and decoder</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;MAPSimple&#39;</span><span class="p">:</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc:0&#39;</span><span class="p">)</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>


                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVInoARD&#39;</span><span class="p">:</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc:0&#39;</span><span class="p">)</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

                                <span class="c1"># debug: reduce stddev initial to zero</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/scale:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                    <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>


                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;ADVIARD&#39;</span><span class="p">:</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc_1:0&#39;</span><span class="p">)</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">para_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/scale_1:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                    <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="c1"># make sure the scale in prior is also near zero, which means prior is like a point mass</span>
                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscale_&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/loc:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                    <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="n">tv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;qscale_&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;/scale:0&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                    <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tv</span><span class="o">.</span><span class="n">get_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TF_FLOAT</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_std_softplus</span><span class="p">))</span>

                                <span class="c1"># tv = self.graph.get_tensor_by_name(key + &#39;/loc_1:0&#39;)</span>
                                <span class="c1">#</span>
                                <span class="c1"># print type(tv), type(para_dict[key])</span>
                                <span class="c1">#</span>
                                <span class="c1"># self.sess.run(tf.assign(tv, para_dict[key]))</span>
                                <span class="c1">#</span>
                                <span class="c1"># # debug: reduce stddev initial to zero</span>
                                <span class="c1"># tv = self.graph.get_tensor_by_name(key + &#39;/scale_1:0&#39;)</span>
                                <span class="c1">#</span>
                                <span class="c1"># self.sess.run(tf.assign(tv, tf.ones(tv.get_shape()) * self.init_std_softplus))</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="k">raise</span> <span class="ne">NotImplementedError</span>

                <span class="c1">## prepare training data as dict for evaluation</span>
                <span class="n">feed_dict_whole_train</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="p">:]}</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_X_list</span><span class="p">)):</span>
                    <span class="n">feed_dict_whole_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">future_X_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_future_train</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="p">:]</span>

                <span class="c1">## prepare validation data as dict for evaluation</span>
                <span class="n">feed_dict_whole_valid</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_valid</span><span class="p">[:,</span> <span class="p">:]}</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_X_list</span><span class="p">)):</span>
                    <span class="n">feed_dict_whole_valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">future_X_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_future_valid</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="p">:]</span>

                <span class="n">feed_dict_whole_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span>
                <span class="n">feed_dict_whole_valid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_train</span>

                <span class="c1">## before training, check initial error</span>

                <span class="n">res_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_train</span><span class="p">)</span>
                <span class="n">train_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="n">res_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_valid</span><span class="p">)</span>
                <span class="n">valid_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_lin_loss_post</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_train</span><span class="p">)</span>

                <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_rec_loss_post</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_valid</span><span class="p">)</span>

                <span class="nb">print</span> <span class="s1">&#39;MAP train_MSE = &#39;</span><span class="p">,</span> <span class="n">train_MSE</span>
                <span class="nb">print</span> <span class="s1">&#39;MAP valid_MSE = &#39;</span><span class="p">,</span> <span class="n">valid_MSE</span>

                <span class="c1">## batch training begin</span>
                <span class="n">tot_batch_loss</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">train_MSE_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">valid_MSE_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">n_iter</span><span class="p">):</span>

                    <span class="c1">## each iteration is processing one batch</span>

                    <span class="c1"># generates the batch!!!</span>
                    <span class="n">X_batch</span><span class="p">,</span> <span class="n">X_future_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                    <span class="c1">## prepare LRAN update dict</span>
                    <span class="n">feed_dict_whole</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="n">X_batch</span><span class="p">[:,</span> <span class="p">:]}</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">X_future_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">feed_dict_whole</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">future_X_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">X_future_batch</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="p">:]</span>


                    <span class="c1">## update with the data!</span>
                    <span class="c1">## it is feeding both X and y</span>
                    <span class="c1"># info_dict = self.inference.update({x: X_batch, y_ph: y_batch})</span>

                    <span class="c1">## change it with the generalized loss</span>
                    <span class="n">z_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X_future_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

                    <span class="n">feed_dict_whole</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">z_ph</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_batch</span>

                    <span class="n">info_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">feed_dict_whole</span><span class="p">)</span>

                    <span class="c1"># inference.print_progress(info_dict)</span>

                    <span class="c1"># summing loss</span>
                    <span class="n">tot_batch_loss</span> <span class="o">+=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

                    <span class="c1"># then we finished with epoch</span>
                    <span class="k">if</span> <span class="n">_</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">res_train_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_train</span><span class="p">)</span>
                        <span class="n">train_MSE_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_train_mean</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="n">res_test_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_valid</span><span class="p">)</span>
                        <span class="n">valid_MSE_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_test_mean</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="n">res_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_train</span><span class="p">)</span>
                        <span class="n">train_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="n">res_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_post</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed_dict_whole_valid</span><span class="p">)</span>
                        <span class="n">valid_MSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">res_test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

                        <span class="c1"># train_MSE = ed.evaluate(&#39;mean_squared_error&#39;,</span>
                        <span class="c1">#                                   data={self.x: self.x_train,</span>
                        <span class="c1">#                                         self.y: self.y_train,</span>
                        <span class="c1">#                                         self.z_post: self.z_train})</span>
                        <span class="c1">#</span>
                        <span class="c1"># valid_MSE = ed.evaluate(&#39;mean_squared_error&#39;,</span>
                        <span class="c1">#                                  data={self.x: self.x_test,</span>
                        <span class="c1">#                                        self.y: self.y_test,</span>
                        <span class="c1">#                                        self.z_post: self.z_test})</span>

                        <span class="nb">print</span> <span class="s1">&#39;&#39;</span>
                        <span class="nb">print</span> <span class="s1">&#39;current epoch = &#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span><span class="p">),</span> <span class="s1">&#39; total epoch = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span>
                        <span class="nb">print</span> <span class="s1">&#39;mean of error residual = &#39;</span><span class="p">,</span> <span class="n">train_MSE_mean</span><span class="p">,</span> <span class="n">valid_MSE_mean</span>
                        <span class="nb">print</span> <span class="s1">&#39;train MSE = &#39;</span><span class="p">,</span> <span class="n">train_MSE</span>
                        <span class="nb">print</span> <span class="s1">&#39;validation MSE = &#39;</span><span class="p">,</span> <span class="n">valid_MSE</span>

                        <span class="c1">## evaluate the Koopman eigenvalues for the mean of the Koopman operator</span>

                        <span class="c1"># sample K to get mean value</span>
                        <span class="n">K_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_K_and_return_mean</span><span class="p">()</span>
                        <span class="n">evalue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">K_mean</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="nb">print</span> <span class="s1">&#39;eigenvalues = &#39;</span><span class="p">,</span> <span class="n">evalue</span>

                        <span class="c1">## write all the stuff into log so I can monitor them on cluster</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;=============================================&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;current epoch = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batch</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; total epoch = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_epoch</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mean of error residual = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_MSE_mean</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">valid_MSE_mean</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;train MSE = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">train_MSE</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;validation MSE = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">valid_MSE</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;eigenvalues = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">evalue</span><span class="p">))</span>

                        <span class="n">train_MSE_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_MSE</span><span class="p">)</span>
                        <span class="n">valid_MSE_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_MSE</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_MSE_list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_MSE_list</span>

                <span class="c1"># end inference.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

                <span class="c1"># close loss log file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loss_log_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


                <span class="c1"># print &#39;total_mse =&#39;, self.total_MSE_list</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_MSE_list</span></div>

<div class="viewcode-block" id="edwardMBTrainerLRAN.get_graph"><a class="viewcode-back" href="../../MODEL_SRC.classBayesDLKoopman.html#MODEL_SRC.classBayesDLKoopman.edwardMBTrainerLRAN.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span></div></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Shaowu Pan

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>